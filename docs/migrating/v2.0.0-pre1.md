# Migrating to Otto v2.0.0-pre1

## What's New in v2.0.0-pre1

This pre-release includes extensive test coverage improvements (76 new test cases), core module refactoring, and middleware stack unification. See the [full changelog](../../CHANGELOG.rst#changelog-2.0.0-pre1) for complete details.

The main breaking change affects applications that directly manipulate the middleware stack.

## Middleware Stack Unified API

Otto v2.0.0-pre1 introduces a significant refactoring of the middleware stack management, providing a more consistent and efficient approach to middleware configuration.

### Key Changes

#### Unified Middleware Registration

Previous versions had separate legacy and new middleware stacks. In v2.0.0-pre1, we've consolidated these into a single, more powerful middleware stack.

**Before:**
```ruby
# Old approach with separate stacks
otto.middleware_stack << SomeMiddleware
otto.middleware.add(AnotherMiddleware)
```

**After:**
```ruby
# Unified middleware registration
otto.use(SomeMiddleware)
otto.use(AnotherMiddleware)
```

#### Performance Improvements

- Middleware lookup is now O(1) using a Set
- Memoized middleware list reduces repeated array creation
- Prevent duplicate middleware registrations with identical configurations

### Migration Steps

1. Replace all `otto.middleware_stack <<` calls with `otto.use()`
2. Remove any direct references to `otto.middleware_stack`
3. Use `otto.middleware.includes?()` instead of manual stack checks

### Authentication and Security Methods

Authentication and security methods now consistently use the new unified middleware stack:

```ruby
# Before
otto.middleware_stack << Otto::Security::CSRFMiddleware

# After (no change needed)
otto.enable_csrf_protection!
```

### Performance Considerations

The new implementation is more memory-efficient and provides faster middleware lookups, especially for applications with many middleware components.

### Potential Breaking Changes

- Code relying on direct manipulation of `middleware_stack` will need updates
- Method signatures for middleware configuration remain the same

### Example Migration

```ruby
# Old code
class MyApp
  def initialize
    @otto = Otto.new
    @otto.middleware_stack << CustomMiddleware
    @otto.middleware.add(AnotherMiddleware)
  end
end

# New code
class MyApp
  def initialize
    @otto = Otto.new
    @otto.use(CustomMiddleware)
    @otto.use(AnotherMiddleware)
  end
end
```

### Troubleshooting

If you encounter any issues with middleware registration or configuration, please file an issue at [Otto GitHub Repository](https://github.com/delano/otto/issues).
